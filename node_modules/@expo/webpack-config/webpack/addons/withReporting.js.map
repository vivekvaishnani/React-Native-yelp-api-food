{"version":3,"file":"withReporting.js","sourceRoot":"","sources":["../../src/addons/withReporting.ts"],"names":[],"mappings":";;;;;AAAA,aAAa;AACb,gFAAsD;AAEtD,qEAA+D;AAE/D,kDAA0B;AAE1B,4CAA6D;AAC7D,gCAAsD;AAEzC,QAAA,yBAAyB,GAGlC;IACF,YAAY,EAAE,QAAQ;IACtB,YAAY,EAAE,MAAM;IACpB,iBAAiB,EAAE,IAAI;IACvB,YAAY,EAAE,KAAK;IACnB,OAAO,EAAE,KAAK;IACd,IAAI,EAAE,YAAY;IAClB,aAAa,EAAE,YAAY;IAC3B,cAAc,EAAE,aAAa;CAC9B,CAAC;AAEF,SAAgB,qBAAqB,CAAC,EAAE,GAAG,GAAG,EAAE,EAAc;IAC5D,MAAM,EAAE,KAAK,GAAG,EAAE,EAAE,GAAG,GAAG,CAAC;IAE3B,IAAI,OAAO,KAAK,CAAC,MAAM,KAAK,WAAW,EAAE;QACvC,MAAM,IAAI,KAAK,CACb,kGAAkG,CACnG,CAAC;KACH;AACH,CAAC;AARD,sDAQC;AAED,SAAgB,sBAAsB,CAAC,GAAgB;IACrD,MAAM,IAAI,GAAG,aAAO,CAAC,GAAG,CAAC,CAAC;IAC1B,IAAI,IAAI,KAAK,aAAa,EAAE;QAC1B,OAAO,CAAC,GAAG,CACT,eAAK,CAAC,QAAQ,CAAC,KAAK,CAAA,sEAAsE,CAC3F,CAAC;KACH;AACH,CAAC;AAPD,wDAOC;AAED,SAAwB,aAAa,CACnC,MAAwC,EACxC,GAAgB;IAEhB,qBAAqB,CAAC,eAAS,CAAC,GAAG,CAAC,CAAC,CAAC;IAEtC,MAAM,YAAY,GAAG,mCAA0B,CAAC,GAAG,CAAC,MAAM,EAAE,iCAAyB,EAAE,IAAI,CAAC,CAAC;IAE7F,IAAI,CAAC,YAAY,EAAE;QACjB,OAAO,MAAM,CAAC;KACf;IACD,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,GAAG,CAAC,SAAS,IAAI,cAAQ,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;IACtE,IAAI,YAAY,CAAC,OAAO,EAAE;QACxB,sBAAsB,CAAC,GAAG,CAAC,CAAC;KAC7B;IACD,MAAM,SAAS,GAAG,YAAY,CAAC,IAAI,CAAC;IACpC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,OAAO,CAAC;QAAE,MAAM,CAAC,OAAO,GAAG,EAAE,CAAC;IAExD,MAAM,CAAC,OAAO,CAAC,IAAI;IACjB,2BAA2B;IAC3B,IAAI,8BAAkB,CAAC,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,EAAE;QAC5C,IAAI;QACJ,GAAG,EAAE,KAAK;QACV,OAAO,EAAE,YAAY,CAAC,OAAO;KAC9B,CAAC;IACF,0CAA0C;IAC1C,aAAa;IACb,IAAI,8CAAoB,mBACnB,YAAY,IACf,QAAQ,EAAE,YAAY,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,EAClD,aAAa,EAAE,QAAQ,CAAC,SAAS,EAAE,YAAY,CAAC,aAAa,CAAC,EAC9D,cAAc,EAAE,QAAQ,CAAC,SAAS,EAAE,YAAY,CAAC,cAAc,CAAC,IAChE,CACH,CAAC;IAEF,OAAO,MAAM,CAAC;AAChB,CAAC;AApCD,gCAoCC","sourcesContent":["// @ts-ignore\nimport CleanWebpackPlugin from 'clean-webpack-plugin';\nimport { Configuration } from 'webpack';\nimport { BundleAnalyzerPlugin } from 'webpack-bundle-analyzer';\nimport { ExpoConfig } from '@expo/config';\nimport chalk from 'chalk';\nimport { DevConfiguration, Environment } from '../types';\nimport { enableWithPropertyOrConfig } from '../utils/config';\nimport { getConfig, getMode, getPaths } from '../env';\n\nexport const DEFAULT_REPORTING_OPTIONS: BundleAnalyzerPlugin.Options & {\n  verbose?: boolean;\n  path: string;\n} = {\n  analyzerMode: 'static',\n  defaultSizes: 'gzip',\n  generateStatsFile: true,\n  openAnalyzer: false,\n  verbose: false,\n  path: 'web-report',\n  statsFilename: 'stats.json',\n  reportFilename: 'report.html',\n};\n\nexport function throwDeprecatedConfig({ web = {} }: ExpoConfig) {\n  const { build = {} } = web;\n\n  if (typeof build.report !== 'undefined') {\n    throw new Error(\n      'expo.web.build.report is deprecated. Please extend webpack.config.js and use env.report instead.'\n    );\n  }\n}\n\nexport function maybeWarnAboutRebuilds(env: Environment) {\n  const mode = getMode(env);\n  if (mode === 'development') {\n    console.log(\n      chalk.bgYellow.black`Generating a report, this will add noticeably more time to rebuilds.`\n    );\n  }\n}\n\nexport default function withReporting(\n  config: Configuration | DevConfiguration,\n  env: Environment\n): Configuration | DevConfiguration {\n  throwDeprecatedConfig(getConfig(env));\n\n  const reportConfig = enableWithPropertyOrConfig(env.report, DEFAULT_REPORTING_OPTIONS, true);\n\n  if (!reportConfig) {\n    return config;\n  }\n  const { absolute, root } = env.locations || getPaths(env.projectRoot);\n  if (reportConfig.verbose) {\n    maybeWarnAboutRebuilds(env);\n  }\n  const reportDir = reportConfig.path;\n  if (!Array.isArray(config.plugins)) config.plugins = [];\n\n  config.plugins.push(\n    // Delete the report folder\n    new CleanWebpackPlugin([absolute(reportDir)], {\n      root,\n      dry: false,\n      verbose: reportConfig.verbose,\n    }),\n    // Generate the report.html and stats.json\n    // @ts-ignore\n    new BundleAnalyzerPlugin({\n      ...reportConfig,\n      logLevel: reportConfig.verbose ? 'info' : 'silent',\n      statsFilename: absolute(reportDir, reportConfig.statsFilename),\n      reportFilename: absolute(reportDir, reportConfig.reportFilename),\n    })\n  );\n\n  return config;\n}\n"]}